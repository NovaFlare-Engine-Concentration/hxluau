name: Testing
on:
    push:
        branches: main
        paths-ignore:
            - "LICENSE"
            - "README.md"
            - "TODO.md"
            - "haxelib.json"
            - "hxformat.json"
    workflow_dispatch:
jobs:
    Windows:
        runs-on: windows-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup MSVC Build Tools
              uses: ilammy/msvc-dev-cmd@v1

            - name: Verify prebuilt Luau library (Windows x64)
              shell: cmd
              run: |
                  echo Verifying prebuilt library exists: project\luau\lib\Windows\x64\luau.lib
                  if not exist "%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\luau.lib" (
                      echo ERROR: Prebuilt luau.lib not found at project\luau\lib\Windows\x64\luau.lib
                      dir "%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\"
                      exit /b 1
                  )
                  echo Found prebuilt luau.lib:
                  dir "%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\"

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-win.hxml
    Linux:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Verify prebuilt Luau library (Linux x64)
              shell: bash
              run: |
                  set -e
                  LIB="project/luau/lib/Linux/x64/libluau.a"
                  echo "Verifying prebuilt library exists: $LIB"
                  if [ ! -f "$LIB" ]; then
                    echo "ERROR: Prebuilt $LIB not found"
                    ls -la project/luau/lib/Linux/x64/ || true
                    exit 1
                  fi
                  echo "Found prebuilt library:" && ls -la "$LIB"

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-unix.hxml
    MacOS:
        runs-on: macos-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Verify prebuilt Luau library (macOS)
              shell: bash
              run: |
                  set -e
                  ARCH="$(uname -m)"
                  if [ "$ARCH" = "arm64" ]; then
                    LIB="project/luau/lib/MacOS/arm64/libluau.a"
                  else
                    LIB="project/luau/lib/MacOS/x64/libluau.a"
                  fi
                  echo "Verifying prebuilt library exists: $LIB"
                  if [ ! -f "$LIB" ]; then
                    echo "ERROR: Prebuilt $LIB not found"
                    ls -la "$(dirname "$LIB")" || true
                    exit 1
                  fi
                  echo "Found prebuilt library:" && ls -la "$LIB"

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-unix.hxml
