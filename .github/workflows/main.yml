name: Testing
on:
    push:
        branches: main
        paths-ignore:
            - "LICENSE"
            - "README.md"
            - "TODO.md"
            - "haxelib.json"
            - "hxformat.json"
    workflow_dispatch:
jobs:
    Windows:
        runs-on: windows-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, ffi, module, override, pass-variable, return-value, simple-call, stack-dump]
        steps:
            - name: Checkout
              uses: actions/checkout@main

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-win.hxml
    Linux:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: false

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Verify or flag build (Linux x64)
              shell: bash
              run: |
                  set -e
                  LIB="project/luau/lib/Linux/x64/libluau.a"
                  echo "Verifying prebuilt library exists: $LIB"
                  if [ -f "$LIB" ]; then
                    # Detect LFS pointer (text file) vs actual archive
                    if head -n 1 "$LIB" | grep -q "git-lfs"; then
                      echo "Detected LFS pointer instead of binary, will build locally"
                      echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                    else
                      echo "Found prebuilt library:" && ls -la "$LIB"
                      echo "NEED_BUILD=0" >> "$GITHUB_ENV"
                    fi
                  else
                    echo "Prebuilt $LIB not found, will build locally"
                    ls -la project/luau/lib/Linux/x64/ || true
                    echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                  fi

            - name: Download prebuilt Luau artifact (Linux x64)
              if: env.NEED_BUILD == '1'
              uses: dawidd6/action-download-artifact@v2
              with:
                  workflow: build-libs.yml
                  workflow_conclusion: success
                  branch: main
                  name: luau-libs-Linux-x64
                  path: _libs_linux_x64

            - name: Place downloaded library (Linux x64)
              if: env.NEED_BUILD == '1'
              shell: bash
              run: |
                  set -e
                  if [ ! -f "_libs_linux_x64/libluau.a" ]; then
                    echo "ERROR: Downloaded artifact missing libluau.a"
                    ls -la _libs_linux_x64 || true
                    exit 1
                  fi
                  mkdir -p project/luau/lib/Linux/x64
                  cp -f _libs_linux_x64/libluau.a project/luau/lib/Linux/x64/libluau.a

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-unix.hxml
    MacOS:
        runs-on: macos-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: false

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Verify or flag build (macOS)
              shell: bash
              run: |
                  set -e
                  ARCH="$(uname -m)"
                  if [ "$ARCH" = "arm64" ]; then
                    LIB="project/luau/lib/MacOS/arm64/libluau.a"
                  else
                    LIB="project/luau/lib/MacOS/x64/libluau.a"
                  fi
                  echo "Verifying prebuilt library exists: $LIB"
                  if [ -f "$LIB" ]; then
                    if head -n 1 "$LIB" | grep -q "git-lfs"; then
                      echo "Detected LFS pointer instead of binary, will build locally"
                      echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                    else
                      echo "Found prebuilt library:" && ls -la "$LIB"
                      echo "NEED_BUILD=0" >> "$GITHUB_ENV"
                    fi
                  else
                    echo "Prebuilt $LIB not found, will build locally"
                    ls -la "$(dirname "$LIB")" || true
                    echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                  fi

            - name: Download prebuilt Luau artifact (macOS arm64)
              if: env.NEED_BUILD == '1' && runner.arch == 'ARM64'
              uses: dawidd6/action-download-artifact@v2
              with:
                  workflow: build-libs.yml
                  workflow_conclusion: success
                  branch: main
                  name: luau-libs-MacOS-arm64
                  path: _libs_macos_arm64

            - name: Place downloaded library (macOS arm64)
              if: env.NEED_BUILD == '1' && runner.arch == 'ARM64'
              shell: bash
              run: |
                  set -e
                  test -f _libs_macos_arm64/libluau.a || { echo "ERROR: missing libluau.a"; ls -la _libs_macos_arm64 || true; exit 1; }
                  mkdir -p project/luau/lib/MacOS/arm64
                  cp -f _libs_macos_arm64/libluau.a project/luau/lib/MacOS/arm64/libluau.a

            - name: Download prebuilt Luau artifact (macOS x64)
              if: env.NEED_BUILD == '1' && runner.arch == 'X64'
              uses: dawidd6/action-download-artifact@v2
              with:
                  workflow: build-libs.yml
                  workflow_conclusion: success
                  branch: main
                  name: luau-libs-MacOS-x64
                  path: _libs_macos_x64

            - name: Place downloaded library (macOS x64)
              if: env.NEED_BUILD == '1' && runner.arch == 'X64'
              shell: bash
              run: |
                  set -e
                  test -f _libs_macos_x64/libluau.a || { echo "ERROR: missing libluau.a"; ls -la _libs_macos_x64 || true; exit 1; }
                  mkdir -p project/luau/lib/MacOS/x64
                  cp -f _libs_macos_x64/libluau.a project/luau/lib/MacOS/x64/libluau.a

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-unix.hxml
