name: Testing
on:
    push:
        branches: main
        paths-ignore:
            - "LICENSE"
            - "README.md"
            - "TODO.md"
            - "haxelib.json"
            - "hxformat.json"
    workflow_dispatch:
jobs:
    Windows:
        runs-on: windows-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: false

            - name: Setup MSVC Build Tools
              uses: ilammy/msvc-dev-cmd@v1

            - name: Verify or flag build (Windows x64)
              shell: cmd
              run: |
                  echo Verifying prebuilt library exists: project\luau\lib\Windows\x64\luau.lib
                  set "LIB=%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\luau.lib"
                  setlocal EnableDelayedExpansion
                  set NEED=0
                  if not exist "%LIB%" (
                      echo Prebuilt luau.lib missing.
                      set NEED=1
                  ) else (
                      rem Detect LFS pointer file (contains 'git-lfs' spec marker)
                      findstr /C:"git-lfs" "%LIB%" >nul 2>&1 && (
                          echo Detected LFS pointer instead of binary.
                          set NEED=1
                      )
                      rem Check file size (pointer files are very small, < 1KB)
                      for %%A in ("%LIB%") do set SIZE=%%~zA
                      echo luau.lib size: !SIZE! bytes
                      if not "!SIZE!"=="" (
                          if !SIZE! LSS 1024 (
                              echo Library looks too small; flagging rebuild.
                              set NEED=1
                          )
                      )
                      rem Validate COFF with dumpbin; if it errors, mark rebuild
                      if !NEED! EQU 0 (
                          dumpbin /headers "%LIB%" >nul 2>&1
                          if errorlevel 1 (
                              echo dumpbin failed; luau.lib may be invalid.
                              set NEED=1
                          ) else (
                              echo dumpbin succeeded; luau.lib appears valid.
                          )
                      )
                  )
                  echo NEED_BUILD=!NEED!>> "%GITHUB_ENV%"

            - name: Download prebuilt Luau artifact (Windows x64)
              if: env.NEED_BUILD == '1'
              uses: dawidd6/action-download-artifact@v2
              with:
                  workflow: build-libs.yml
                  workflow_conclusion: success
                  branch: main
                  name: luau-libs-Windows-x64
                  path: _libs_win_x64

            - name: Place downloaded library (Windows x64)
              if: env.NEED_BUILD == '1'
              shell: cmd
              continue-on-error: true
              run: |
                  if not exist "_libs_win_x64\luau.lib" (
                      echo ERROR: Downloaded artifact missing luau.lib
                      dir _libs_win_x64
                      exit /b 1
                  )
                  mkdir "%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64" 2>nul
                  copy /Y "_libs_win_x64\luau.lib" "%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\luau.lib"

            - name: Build Luau locally (Windows fallback)
              if: env.NEED_BUILD == '1'
              shell: cmd
              run: |
                  setlocal EnableDelayedExpansion
                  set "LIB=%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\luau.lib"
                  if exist "%LIB%" (
                      echo Library already present, skipping fallback build.
                  ) else (
                      echo Building Luau locally as fallback...
                      rmdir /s /q project\luau 2>nul
                      git clone https://github.com/luau-lang/luau.git project\luau
                      cd project\luau
                      mkdir build
                      cd build
                      cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
                      cmake --build . --config Release
                      set FILES=
                      for /r %%f in (Luau.*.lib) do set FILES=!FILES! "%%f"
                      if "!FILES!"=="" (
                        echo No Luau.*.lib found. Failing.
                        exit /b 1
                      )
                      lib.exe /OUT:luau.lib !FILES!
                      if errorlevel 1 exit /b %errorlevel%
                      mkdir ..\lib\Windows\x64 2>nul
                      copy luau.lib ..\lib\Windows\x64\luau.lib
                  )

            - name: Validate library (Windows x64)
              shell: cmd
              run: |
                  setlocal EnableDelayedExpansion
                  set "LIB=%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\luau.lib"
                  if not exist "%LIB%" (
                      echo ERROR: luau.lib not found after placement
                      dir "%GITHUB_WORKSPACE%\project\luau\lib\Windows\x64\"
                      exit /b 1
                  )

                  rem Validate using dumpbin if available, and lib.exe /LIST as authoritative
                  set INVALID=0

                  rem Optional: dumpbin headers check
                  where dumpbin >nul 2>&1 && (
                      echo Validating COFF library with dumpbin...
                      dumpbin /headers "%LIB%" >nul 2>&1
                      if errorlevel 1 (
                          echo Warning: dumpbin failed; proceeding to lib.exe validation.
                      ) else (
                          echo dumpbin succeeded.
                      )
                  ) || (
                      echo dumpbin not found; skipping dumpbin validation.
                  )

                  rem Authoritative check: list members via lib.exe
                  echo Validating library contents with lib.exe /LIST...
                  lib.exe /NOLOGO /LIST "%LIB%" >nul 2>&1
                  if errorlevel 1 (
                      echo ERROR: lib.exe failed to read the library; luau.lib is invalid or corrupt.
                      echo Tip: Ensure build-libs.yml produced a Windows MSVC .lib and the artifact is accessible.
                      exit /b 1
                  ) else (
                      echo lib.exe validation succeeded; luau.lib appears valid.
                  )

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-win.hxml
    Linux:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: false

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Verify or flag build (Linux x64)
              shell: bash
              run: |
                  set -e
                  LIB="project/luau/lib/Linux/x64/libluau.a"
                  echo "Verifying prebuilt library exists: $LIB"
                  if [ -f "$LIB" ]; then
                    # Detect LFS pointer (text file) vs actual archive
                    if head -n 1 "$LIB" | grep -q "git-lfs"; then
                      echo "Detected LFS pointer instead of binary, will build locally"
                      echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                    else
                      echo "Found prebuilt library:" && ls -la "$LIB"
                      echo "NEED_BUILD=0" >> "$GITHUB_ENV"
                    fi
                  else
                    echo "Prebuilt $LIB not found, will build locally"
                    ls -la project/luau/lib/Linux/x64/ || true
                    echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                  fi

            - name: Download prebuilt Luau artifact (Linux x64)
              if: env.NEED_BUILD == '1'
              uses: dawidd6/action-download-artifact@v2
              with:
                  workflow: build-libs.yml
                  workflow_conclusion: success
                  branch: main
                  name: luau-libs-Linux-x64
                  path: _libs_linux_x64

            - name: Place downloaded library (Linux x64)
              if: env.NEED_BUILD == '1'
              shell: bash
              continue-on-error: true
              run: |
                  set -e
                  if [ ! -f "_libs_linux_x64/libluau.a" ]; then
                    echo "ERROR: Downloaded artifact missing libluau.a"
                    ls -la _libs_linux_x64 || true
                    exit 1
                  fi
                  mkdir -p project/luau/lib/Linux/x64
                  cp -f _libs_linux_x64/libluau.a project/luau/lib/Linux/x64/libluau.a

            - name: Build Luau locally (Linux fallback)
              if: env.NEED_BUILD == '1'
              shell: bash
              run: |
                set -e
                LIB="project/luau/lib/Linux/x64/libluau.a"
                REBUILD=1
                if [ -f "$LIB" ]; then
                  if ar -t "$LIB" >/dev/null 2>&1; then
                    echo "Valid libluau.a present; skipping fallback build."
                    REBUILD=0
                  else
                    echo "Existing libluau.a is invalid; will rebuild."
                  fi
                fi
                if [ "$REBUILD" = "1" ]; then
                  echo "Building Luau locally as fallback..."
                  rm -rf project/luau
                  git clone https://github.com/luau-lang/luau.git project/luau
                  cd project/luau
                  mkdir -p build && cd build
                  cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release
                  cmake --build . --config Release
                  echo "create libluau.a" > combine.mri
                  find . -name 'libLuau.*.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
                  echo "save" >> combine.mri
                  echo "end" >> combine.mri
                  ar -M < combine.mri
                  ranlib libluau.a
                  mkdir -p ../lib/Linux/x64
                  cp libluau.a ../lib/Linux/x64/libluau.a
                fi

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-unix.hxml
    MacOS:
        runs-on: macos-latest
        strategy:
            fail-fast: false
            matrix:
                sample: [alter-state, array, callback, module, override, pass-variable, return-value, simple-call, stack-dump, luau-syntax]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  lfs: false

            - name: Setup Haxe
              uses: krdlab/setup-haxe@master
              with:
                  haxe-version: 4.3.6

            - name: Verify or flag build (macOS)
              shell: bash
              run: |
                  set -e
                  ARCH="$(uname -m)"
                  if [ "$ARCH" = "arm64" ]; then
                    LIB="project/luau/lib/MacOS/arm64/libluau.a"
                  else
                    LIB="project/luau/lib/MacOS/x64/libluau.a"
                  fi
                  echo "Verifying prebuilt library exists: $LIB"
                  if [ -f "$LIB" ]; then
                    if head -n 1 "$LIB" | grep -q "git-lfs"; then
                      echo "Detected LFS pointer instead of binary, will build locally"
                      echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                    else
                      echo "Found prebuilt library:" && ls -la "$LIB"
                      echo "NEED_BUILD=0" >> "$GITHUB_ENV"
                    fi
                  else
                    echo "Prebuilt $LIB not found, will build locally"
                    ls -la "$(dirname "$LIB")" || true
                    echo "NEED_BUILD=1" >> "$GITHUB_ENV"
                  fi

            - name: Download prebuilt Luau artifact (macOS arm64)
              if: env.NEED_BUILD == '1' && runner.arch == 'ARM64'
              uses: dawidd6/action-download-artifact@v2
              with:
                  workflow: build-libs.yml
                  workflow_conclusion: success
                  branch: main
                  name: luau-libs-MacOS-arm64
                  path: _libs_macos_arm64

            - name: Place downloaded library (macOS arm64)
              if: env.NEED_BUILD == '1' && runner.arch == 'ARM64'
              shell: bash
              continue-on-error: true
              run: |
                  set -e
                  test -f _libs_macos_arm64/libluau.a || { echo "ERROR: missing libluau.a"; ls -la _libs_macos_arm64 || true; exit 1; }
                  mkdir -p project/luau/lib/MacOS/arm64
                  cp -f _libs_macos_arm64/libluau.a project/luau/lib/MacOS/arm64/libluau.a

            - name: Build Luau locally (macOS arm64 fallback)
              if: env.NEED_BUILD == '1' && runner.arch == 'ARM64'
              shell: bash
              run: |
                set -e
                LIB="project/luau/lib/MacOS/arm64/libluau.a"
                REBUILD=1
                if [ -f "$LIB" ]; then
                  if ar -t "$LIB" >/dev/null 2>&1; then
                    echo "Valid libluau.a present; skipping fallback build."
                    REBUILD=0
                  else
                    echo "Existing libluau.a is invalid; will rebuild."
                  fi
                fi
                if [ "$REBUILD" = "1" ]; then
                  echo "Building Luau locally as fallback (arm64)..."
                  rm -rf project/luau
                  git clone https://github.com/luau-lang/luau.git project/luau
                  cd project/luau
                  mkdir -p build && cd build
                  cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64
                  cmake --build . --config Release
                  libs=$(find . -name 'libLuau.*.a' -type f)
                  if [ -z "$libs" ]; then echo "No libLuau.*.a found"; exit 1; fi
                  libtool -static -o libluau.a $libs
                  ranlib libluau.a
                  mkdir -p ../lib/MacOS/arm64
                  cp libluau.a ../lib/MacOS/arm64/libluau.a
                fi

            - name: Prune wrong-arch library (macOS arm64)
              if: runner.arch == 'ARM64'
              shell: bash
              run: |
                set -e
                # Remove x64 lib to avoid accidental linkage on ARM64
                rm -f project/luau/lib/MacOS/x64/libluau.a || true

            - name: Download prebuilt Luau artifact (macOS x64)
              if: env.NEED_BUILD == '1' && runner.arch == 'X64'
              uses: dawidd6/action-download-artifact@v2
              with:
                  workflow: build-libs.yml
                  workflow_conclusion: success
                  branch: main
                  name: luau-libs-MacOS-x64
                  path: _libs_macos_x64

            - name: Place downloaded library (macOS x64)
              if: env.NEED_BUILD == '1' && runner.arch == 'X64'
              shell: bash
              continue-on-error: true
              run: |
                  set -e
                  test -f _libs_macos_x64/libluau.a || { echo "ERROR: missing libluau.a"; ls -la _libs_macos_x64 || true; exit 1; }
                  mkdir -p project/luau/lib/MacOS/x64
                  cp -f _libs_macos_x64/libluau.a project/luau/lib/MacOS/x64/libluau.a

            - name: Build Luau locally (macOS x64 fallback)
              if: env.NEED_BUILD == '1' && runner.arch == 'X64'
              shell: bash
              run: |
                set -e
                LIB="project/luau/lib/MacOS/x64/libluau.a"
                REBUILD=1
                if [ -f "$LIB" ]; then
                  if ar -t "$LIB" >/dev/null 2>&1; then
                    echo "Valid libluau.a present; skipping fallback build."
                    REBUILD=0
                  else
                    echo "Existing libluau.a is invalid; will rebuild."
                  fi
                fi
                if [ "$REBUILD" = "1" ]; then
                  echo "Building Luau locally as fallback (x64)..."
                  rm -rf project/luau
                  git clone https://github.com/luau-lang/luau.git project/luau
                  cd project/luau
                  mkdir -p build && cd build
                  cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64
                  cmake --build . --config Release
                  libs=$(find . -name 'libLuau.*.a' -type f)
                  if [ -z "$libs" ]; then echo "No libLuau.*.a found"; exit 1; fi
                  libtool -static -o libluau.a $libs
                  ranlib libluau.a
                  mkdir -p ../lib/MacOS/x64
                  cp libluau.a ../lib/MacOS/x64/libluau.a
                fi

            - name: Prune wrong-arch library (macOS x64)
              if: runner.arch == 'X64'
              shell: bash
              run: |
                set -e
                # Remove arm64 lib to avoid accidental linkage on x64
                rm -f project/luau/lib/MacOS/arm64/libluau.a || true

            - name: Compiling
              run: |
                  haxelib install hxcpp --quiet
                  haxelib dev hxluau .
                  cd examples/${{matrix.sample}}
                  haxe build-unix.hxml
